type Op = (stack: string[]) => string[]

const lookup: Record<string, Op> = {
  0: (s) => ['0', ...s],
  1: (s) => ['1', ...s],
  2: (s) => ['2', ...s],
  3: (s) => ['3', ...s],
  4: (s) => ['4', ...s],
  5: (s) => ['5', ...s],
  6: (s) => ['6', ...s],
  7: (s) => ['7', ...s],
  8: (s) => ['8', ...s],
  9: (s) => ['9', ...s],
  a: (s) => ['10', ...s],
  b: (s) => ['11', ...s],
  c: (s) => ['12', ...s],
  d: (s) => ['13', ...s],
  e: (s) => ['14', ...s],
  f: (s) => ['15', ...s],
  g: ([a, ...s]) => [a, ...s],
  h: ([a, ...s]) => [`(${a}/2)`, ...s],
  i: ([a, ...s]) => [`(${a}+1)`, ...s],
  j: ([a, ...s]) => [a, ...s],
  k: ([a, ...s]) => [a, ...s],
  l: ([a, ...s]) => [a, ...s],
  m: ([a, ...s]) => [`(${a}+t)`, ...s],
  n: ([a, ...s]) => [`(-${a})`, ...s],
  o: ([a, ...s]) => [a, ...s],
  p: (s) => ["Math.PI", ...s],
  q: ([a, ...s]) => [`(${a}/4)`, ...s],
  r: ([a, ...s]) => [a, ...s],
  s: ([a, ...s]) => [a, ...s],
  t: (s) => ["t", ...s],
  u: ([a, ...s]) => [`(${a}-1)`, ...s],
  v: ([a, ...s]) => [`(${a}*2)`, ...s],
  w: ([a, ...s]) => [`(${a}*4)`, ...s],
  x: (s) => [`x`, ...s],
  y: (s) => [`y`, ...s],
  z: ([a, b, c, ...s]) => [`noise(${c} || 0, ${b} || 0, ${a})`, ...s],
  A: ([a, ...s]) => [`Math.abs(${a})`, ...s],
  B: ([a, ...s]) => [a, ...s],
  C: ([a, ...s]) => [`Math.cos(${a})`, ...s],
  D: ([a, ...s]) => [a, ...s],
  E: ([a, ...s]) => [a, ...s],
  F: ([a, ...s]) => [`Math.floor(${a})`, ...s],
  G: ([a, ...s]) => [`Math.ceil(${a})`, ...s],
  H: ([a, b, ...s]) => [`Math.hypot(${a}, ${b})`, ...s],
  I: ([a, ...s]) => [`(1/${a})`, ...s],
  J: ([a, ...s]) => [a, ...s],
  K: ([a, b, ...s]) => [`Math.atan2(${b}, ${a})`, ...s],
  L: (s) => ["128", ...s],
  M: ([a, ...s]) => [`Math.max(${a}, 0)`, ...s],
  N: ([a, ...s]) => [`Math.min(${a}, 0)`, ...s],
  O: ([a, ...s]) => [`Math.round(${a})`, ...s],
  P: (s) => [`(Math.PI * 2)`, ...s],
  Q: ([a, ...s]) => [`Math.sqrt(${a})`, ...s],
  R: ([a, ...s]) => [`Math.round(${a})`, ...s],
  S: ([a, ...s]) => [`Math.sin(${a})`, ...s],
  T: ([a, ...s]) => [`Math.tan(${a})`, ...s],
  U: (s) => [`Math.cos(t)`, ...s],
  V: (s) => [`Math.sin(t)`, ...s],
  W: ([a, ...s]) => [`${a}*${a}`, ...s],
  X: (s) => [`(x-16)`, ...s],
  Y: (s) => [`(y-16)`, ...s],
  Z: ([a, ...s]) => [a, ...s],
  '+': ([a, b, ...s]) => [`(${b}+${a})`, ...s],
  '-': ([a, b, ...s]) => [`(${b}-${a})`, ...s],
  '*': ([a, b, ...s]) => [`(${b}*${a})`, ...s],
  '/': ([a, b, ...s]) => [`(${b}/${a})`, ...s],
  '%': ([a, b, ...s]) => [`(${b}%${a})`, ...s],
  '^': ([a, b, ...s]) => [`Math.pow(${b}, ${a})`, ...s],
  '=': ([a, b, ...s]) => [`(${b}==${a})`, ...s],
  '!': ([a, ...s]) => [a, ...s],
  '>': ([a, b, ...s]) => [`(${b}>${a})`, ...s],
  '<': ([a, b, ...s]) => [`(${b}<${a})`, ...s],
  '&': ([a, b, ...s]) => [a, b, ...s],
  '|': ([a, b, ...s]) => [a, b, ...s],
  '?': ([a, b, c, ...s]) => [`(${a}?${b}:${c})`, ...s],
  ':': ([a, b, ...s]) => [a, b, ...s],
  '.': (s) => ["throw 'dot product not implemented'", ...s],
  ',': (s) => ["throw 'vectorize'", ...s],
  '~': ([a, ...s]) => [a, ...s],
  '`': ([a, ...s]) => [a, ...s],
  '#': ([a, ...s]) => [a, ...s],
  '@': ([a, ...s]) => [a, ...s],
  '$': ([a, ...s]) => [a, ...s],
  '_': (s) => ["_", ...s],
  '(': ([a, ...s]) => {
    return [`([...Array(16)].reduce((_) => ${a}, 0))`, ...s]
  },
  ')': ([a, ...s]) => [a, ...s],
  '[': ([a, ...s]) => [a, ...s],
  ']': ([a, ...s]) => [a, ...s],
  '{': ([a, ...s]) => [a, ...s],
  '}': ([a, ...s]) => [a, ...s],
  '\\': ([a, ...s]) => [a, ...s],
  ';': ([a, ...s]) => [a, ...s],
  '"': ([a, ...s]) => [a, ...s],
  "'": ([a, ...s]) => [a, ...s],
}

export const getString = (input: string) => {
  const [result] = input.split('').reduce((s, c) => (lookup[c] || (() => [c, ...s]))(s), [] as string[])
  return result
}

const compile = (input: string) => {
  const result = getString(input);
  return new Function('x', 'y', 't', 'noise', `"use strict";const _=0;return ${result}`)
}

export default compile
